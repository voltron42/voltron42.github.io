<html>
    <head>
        <title>Simon</title>
        <script type="text/javascript">
            (function(){
                let Beeper = function({type, volume}) {
                    let makeBeeper = function({frequency,callback}) {
                        let audioCtx = new (window.AudioContext || window.webkitAudioContext || window.audioContext);
                        let oscillator = audioCtx.createOscillator();
                        let gainNode = audioCtx.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioCtx.destination);
                        if (volume){gainNode.gain.value = volume;}
                        if (type){oscillator.type = type;}
                        if (frequency){oscillator.frequency.value = frequency;}
                        if (callback){oscillator.onended = callback;}
                        return oscillator;
                    }
                    this.startBeep = function(args) {
                        let oscillator = makeBeeper(args);
                        oscillator.start();
                        return function() {
                            oscillator.stop();
                        }
                    }
                    this.beep = function(args){
                        let oscillator = makeBeeper(args);
                        oscillator.start();
                        setTimeout(() => { oscillator.stop(); }, args.duration * 1000);
                    }
                }
                let config = {
                    tones: { green:415, red:310, yellow:252, blue:209 },
                    loserTone:{
                        frequency: 42,
                        duration: 1.5
                    },
                    inGameTimeOut:3,
                    victoryTone: { // after each level is completed, use last color
                        delay:0.8,
                        times:[0.02,0.07,0.07,0.07,0.07,0.07],
                        rest:0.02
                    },
                    finalVictory:{ // after final level
                        signalDuration:0.1,
                        order: ["red","yellow","blue","green"],
                        steps: [{
                            tone:"${color}",
                            count:14,
                        },{
                            tone:"razz",
                            count:8
                        }]
                    },
                    sequence: {
                        maxLength: 31,
                        difficulties: [
                            {
                                minLength: 1,
                                maxLength: 5,
                                duration: 0.42,
                                rest: 0.05
                            },
                            {
                                minLength: 6,
                                maxLength: 13,
                                duration: 0.32,
                                rest: 0.05
                            },
                            {
                                minLength: 14,
                                maxLength: 31,
                                duration: 0.22,
                                rest: 0.05
                            },
                        ]
                    }
                }
                window.init = function() {
                    let beeper = new Beeper({type:"triangle",volume:1})
                    let gameState = {
                        status: "open",
                        rects:{},
                        links:{}
                    };
                    let pressColor = function(color) {
                        gameState.stopBeep = beeper.startBeep({frequency:config.tones[color]});
                        gameState.rects[color].classList.add("active");
                    }
                    let releaseColor = function(color) {
                        gameState.rects[color].classList.remove("active");
                        gameState.stopBeep();
                    }
                    let startNewGame = function() {
                        console.log("start game");
                        // todo
                    }
                    let select = function(color) {
                        if (gameState.status === "open") {
                            pressColor(color);
                        }
                    }
                    let deselect = function(color) {
                        if (gameState.status === "open") {
                            releaseColor(color);
                        }
                    }
                    Object.keys(config.tones).forEach((colorName) => {
                        let linkId = colorName + "Link";
                        let linkElement = document.getElementById(linkId);
                        gameState.links[colorName] = linkElement;
                        gameState.rects[colorName] = document.getElementById(colorName);
                        linkElement.addEventListener("mousedown", () => { select(colorName); });
                        linkElement.addEventListener("mouseup", () => { deselect(colorName); });
                    });
                    document.getElementById("bgLink").addEventListener("dblclick", () => {
                        if (gameState.status === "open" && confirm("Start New Game?")) {
                            startNewGame();
                        }
                    });
                }
            })()
        </script>
        <style type="text/css">
            body {
                background-color: black;
            }
            #green.active {
                fill: lightgreen;
            }
            #red.active {
                fill: #ffcccb;
            }
            #yellow.active {
                fill: lightyellow;
            }
            #blue.active {
                fill: lightblue;
            }
        </style>
    </head>
    <body onload="init()">
        <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
            <a id="bgLink" href="#" onclick="event.preventDefault()">
                <rect id="bg" width="100" height="100" fill="black"/>
            </a>
            <a id="greenLink" href="#" onclick="event.preventDefault()">
                <rect id="green" x="2" y="2" width="47" height="47" fill="green"/>
            </a>
            <a id="redLink" href="#" onclick="event.preventDefault()">
                <rect id="red" x="51" y="2" width="47" height="47" fill="red"/>
            </a>
            <a id="yellowLink" href="#" onclick="event.preventDefault()">
                <rect id="yellow" x="2" y="51" width="47" height="47" fill="yellow"/>
            </a>
            <a id="blueLink" href="#" onclick="event.preventDefault()">
                <rect id="blue" x="51" y="51" width="47" height="47" fill="blue"/>
            </a>
        </svg>
    </body>
</html>